<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" style="height: 100%;">
<head>
    <title>PE.js demo</title>
    <script src="pe.js"></script>
    <style>
    .dragover {
    	border: solid 4px gold;
    }
    </style>
    <script>

var loadedFiles = {};

function init() {
  dragSite.ondragover = dragSite_dragenter;
  dragSite.ondragenter = dragSite_dragenter;
  dragSite.ondragleave = dragSite_dragleave;
  dragSite.ondrop = dragSite_drop;

  if (window.opener && window.location.hash) {
	var loadFileArgument = window.opener.loadedFiles[window.location.hash];
	delete window.opener.loadedFiles[window.location.hash];

	onFileLoaded(loadFileArgument.file, loadFileArgument.peFile, loadFileArgument.reader);
  }

  loadButton.onclick = function() {
	alert("onclick");
  };
}

function dragSite_dragenter(e) {
  dragSite.className += " dragover";
  e.cancelBubble = true;
  return false;
}

function dragSite_dragleave(e) {
  dragSite.className = dragSite.className.replace(/ dragover/g, "");
  e.cancelBubble = true;
  return false;
}

function dragSite_drop(e) {
  dragSite.className = dragSite.className.replace(/ dragover/g, "");
  e.cancelBubble = true;

  try {
  if (e.dataTransfer && e.dataTransfer.files) {
	handleDrop(e.dataTransfer.files);
  }
  }
  catch (error) {
  	setTimeout(function() {
  		alert(error);
  	}, 10);
  }

  return false;
}

function handleDrop(files) {
  for (var i = 0; i < files.length; i++) {
	loadFile(files[i]);
  }
}

function loadFile(f) {
  pe.io.getFileBinaryReader(
	f,
	function(reader) {
	  var pef = new pe.headers.PEFile();
	  pef.read(reader);
	  onFileLoaded(f, pef, reader);
	},
	function(errorGettingReader) {
	  alert(errorGettingReader);
	});
}

var isInitialFileLoaded;

function onFileLoaded(f, pef, reader) {
  var newLinkToOpen = document.createElement("a");
  newLinkToOpen.href = "#";
  newLinkToOpen.innerText = f.name + " " + pef;
  linksToOpen.appendChild(newLinkToOpen);
  var emptySpace = document.createElement("span");
  emptySpace.innerText = " ";
  linksToOpen.appendChild(emptySpace);

  newLinkToOpen.onclick = function() {
	linksToOpen.removeChild(newLinkToOpen);
	linksToOpen.removeChild(emptySpace);

	var createUrl = window.location + "";
	if (window.location.hash && window.location.hash.length>0)
	  createUrl = createUrl.substring(0, createUrl.length - window.location.hash.length);

	if (createUrl.substring(createUrl.length-1)==="#")
	  createUrl = createUrl.substring(0, createUrl.length-1);

	createUrl += "#" + f.name;

	loadedFiles["#" + f.name] = { file: f, peFile: pef, reader: reader };

	var newWindow = window.open(createUrl);
  };
}

window.onload = init;
    </script>
</head>
<body style="overflow: hidden; margin: 0px; padding: 0px; height: 100%;">

<table width="100%" height="90%" style="height: 100%;"><tr><td valign="top">

<div id="dragSite" style="height: 100%;">

<table style="width:100%;"><tr><td>
<h2>PE.js demo</h2>
</td><td align="right">
<button id="loadButton"> open local file </button>
</td></tr></table>
<div id="linksToOpen">
</div>
 

<div id="peSite" style="overflow: auto;">
</div>

</div>	

</td><td width="20%" valign="top">
	<iframe src="tests/index.html" style="width: 100%; height: 100%;">
	</iframe>
</td></tr></table>

</body>
</html>